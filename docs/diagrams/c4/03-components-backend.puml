@startuml 03-components-backend
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

' Generated by C4 Diagram Generator
' Agent: C4 Diagram Generator
' System: TravelSplit v1.0.0
' Date: 2026-01-15

title TravelSplit - Backend Components Diagram

' Container
Container_Boundary(backend_api, "Backend API") {
    
    ' Common Components
    Component(jwt_strategy, "JWT Strategy", "Passport Strategy", "Estrategia de autenticacion JWT. Valida tokens y extrae informacion del usuario.")
    Component(jwt_auth_guard, "JWT Auth Guard", "NestJS Guard", "Protege rutas que requieren autenticacion. Valida tokens JWT.")
    Component(http_exception_filter, "HTTP Exception Filter", "Exception Filter", "Filtro global para manejar excepciones HTTP y formatear respuestas de error.")
    Component(user_mapper, "User Mapper", "Mapper Utility", "Mapea entidades User a DTOs de respuesta, excluyendo informacion sensible.")
    Component(trip_mapper, "Trip Mapper", "Mapper Utility", "Mapea entidades Trip a DTOs de respuesta con informacion de participantes.")
    
    ' Auth Module
    Component(auth_controller, "Auth Controller", "NestJS Controller", "Maneja peticiones HTTP de autenticacion: login y registro.")
    Component(auth_service, "Auth Service", "NestJS Service", "Contiene logica de negocio de autenticacion: validacion de credenciales, generacion de tokens JWT.")
    
    ' Users Module
    Component(users_controller, "Users Controller", "NestJS Controller", "Maneja peticiones HTTP de gestion de usuarios: consultar, actualizar, eliminar.")
    Component(users_service, "Users Service", "NestJS Service", "Contiene logica de negocio de usuarios: creacion, actualizacion, eliminacion logica, validaciones.")
    Component(user_entity, "User Entity", "TypeORM Entity", "Entidad que representa un usuario en la base de datos. Incluye soft delete.")
    
    ' Trips Module
    Component(trips_controller, "Trips Controller", "NestJS Controller", "Maneja peticiones HTTP de gestion de viajes: crear, listar, unirse, obtener detalles.")
    Component(trips_service, "Trips Service", "NestJS Service", "Contiene logica de negocio de viajes: creacion, invitacion de participantes, generacion de codigos, autorizacion por roles.")
    Component(trip_entity, "Trip Entity", "TypeORM Entity", "Entidad que representa un viaje en la base de datos.")
    Component(trip_participant_entity, "Trip Participant Entity", "TypeORM Entity", "Entidad que representa la relacion entre usuarios y viajes con roles (CREATOR/MEMBER).")
    
    ' Health Module
    Component(health_controller, "Health Controller", "NestJS Controller", "Maneja peticiones HTTP de health check.")
    Component(health_service, "Health Service", "NestJS Service", "Contiene logica para verificar el estado del sistema.")
}

' Database
ContainerDb(database, "PostgreSQL Database", "PostgreSQL 17", "Base de datos relacional")

' External Systems
System_Ext(jwt_service, "JWT Service", "Servicio de NestJS para generar y validar tokens JWT")
System_Ext(bcrypt, "Bcrypt", "Libreria para hashing de contraseñas")

' Relationships - Auth Module
Rel(auth_controller, auth_service, "Usa", "Dependency Injection")
Rel(auth_service, users_service, "Usa", "Dependency Injection")
Rel(auth_service, jwt_service, "Genera tokens", "Dependency Injection")
Rel(auth_service, bcrypt, "Valida contraseñas", "Library Call")

' Relationships - Users Module
Rel(users_controller, users_service, "Usa", "Dependency Injection")
Rel(users_service, user_entity, "Lee y escribe", "TypeORM Repository")
Rel(users_service, bcrypt, "Hashea contraseñas", "Library Call")
Rel(user_entity, database, "Persiste", "SQL")

' Relationships - Trips Module
Rel(trips_controller, trips_service, "Usa", "Dependency Injection")
Rel(trips_service, trip_entity, "Lee y escribe", "TypeORM Repository")
Rel(trips_service, trip_participant_entity, "Lee y escribe", "TypeORM Repository")
Rel(trips_service, user_entity, "Lee", "TypeORM Repository")
Rel(trip_entity, database, "Persiste", "SQL")
Rel(trip_participant_entity, database, "Persiste", "SQL")

' Relationships - Health Module
Rel(health_controller, health_service, "Usa", "Dependency Injection")

' Relationships - Common Components
Rel(auth_controller, jwt_auth_guard, "Usa", "Guard")
Rel(trips_controller, jwt_auth_guard, "Usa", "Guard")
Rel(users_controller, jwt_auth_guard, "Usa", "Guard")
Rel(jwt_auth_guard, jwt_strategy, "Usa", "Strategy")
Rel(auth_controller, user_mapper, "Usa", "Mapper")
Rel(trips_controller, trip_mapper, "Usa", "Mapper")
Rel(users_controller, user_mapper, "Usa", "Mapper")
Rel(http_exception_filter, backend_api, "Filtra excepciones", "Global Filter")

@enduml
