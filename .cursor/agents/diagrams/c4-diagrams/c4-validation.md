# C4 Validation Rules

## Purpose

Validates PlantUML syntax and ensures diagrams correctly reflect discovered information.

---

## Validation Process

### Step 1: Discovery Consistency Check

Verify diagram content matches Discovery Summary:

| Check | Discovery Field | Diagram Element |
|-------|-----------------|-----------------|
| System name | `diagram_strategy.context.system_name` | `title`, `System()` |
| Users | `diagram_strategy.context.users[]` | `Person()` count |
| External systems | `infrastructure.external_services[]` | `System_Ext()` count |
| Containers | `diagram_strategy.containers[]` | `Container()` count |
| Modules | `components.backend[]` | Component groups |
| Technologies | `stack.*` | Technology strings |

### Step 2: Syntax Validation

Verify PlantUML syntax is correct.

### Step 3: Rendering Test

Test diagram renders without errors.

---

## Syntax Validation Checklist

### @startuml Directive

| Rule | Example |
|------|---------|
| Format | `@startuml {kebab-case-name}` |
| Lowercase only | `@startuml 03-components-backend` |
| No spaces | `@startuml 01-context` (NOT `01 context`) |
| No pipes | `@startuml 02-containers` (NOT `02-containers\|`) |
| No uppercase | `@startuml 03-components-backend` (NOT `03-components-Backend`) |

**Correct Examples:**
- `@startuml 01-context`
- `@startuml 02-containers`
- `@startuml 03-components-backend`
- `@startuml 04-code-users`

**Incorrect Examples (DO NOT USE):**
- `@startuml 01 context Diagram|` (spaces and pipe)
- `@startuml 03-components-Backend` (uppercase B)
- `@startuml 01-context |` (trailing pipe)

### Rel() Statements

| Scenario | Correct Syntax |
|----------|----------------|
| Without technology | `Rel(source, target, "Label")` |
| With technology | `Rel(source, target, "Label", "Technology")` |

**NEVER use empty string:**
```plantuml
' WRONG
Rel(source, target, "Label", "")

' CORRECT
Rel(source, target, "Label")
```

### Metadata Comments

Include at the top of every diagram:

```plantuml
' Generated by C4 Diagram Generator on {YYYY-MM-DD}
' Agent: C4 Diagram Generator
' System: {system_name} v{version}
```

---

## Level-Specific Validation

### Context Diagram (Level 1)

| Validation | Source |
|------------|--------|
| System name matches | `diagram_strategy.context.system_name` |
| All users present | `diagram_strategy.context.users[]` |
| All external systems | `infrastructure.external_services[]` |

### Container Diagram (Level 2)

| Validation | Source |
|------------|--------|
| All containers present | `diagram_strategy.containers[]` |
| Technologies correct | `stack.backend`, `stack.frontend` |
| Database type matches | `stack.backend.database` |
| System boundary named | `diagram_strategy.context.system_name` |

### Component Diagram (Level 3)

| Validation | Source |
|------------|--------|
| Architecture pattern applied | `architecture.backend.pattern` |
| All modules present | `components.backend[]` |
| Technology labels match stack | `stack.backend.framework`, `stack.backend.orm` |
| NO `Container_Boundary` | - |

### Code Diagram (Level 4)

| Validation | Source |
|------------|--------|
| Stereotypes match stack | `stack.backend.framework` |
| No generic types in properties | - |
| No generic types in relationships | - |
| Classes match actual code | Module files |

---

## Known Issues and Solutions

### Issue: "Assumed diagram type: sequence"

**Cause:** Using `Container_Boundary` in Component Diagrams

**Solution:**
- Remove all `Container_Boundary` from Component Diagrams
- Use `Component` and `ComponentDb` directly
- Use comments for logical grouping

### Issue: Generic Types Syntax Error

**Cause:** `Repository<User>` in class diagrams

**Solution:**
- Remove generic type parameters
- Use `Repository` instead of `Repository<User>`
- Define base Repository class separately if needed

### Issue: VS Code PlantUML Viewer Errors

**Solutions:**
1. Test in [PlantUML Online Server](http://www.plantuml.com/plantuml/uml/)
2. Restart VS Code
3. Use "PlantUML: Export Current Diagram" command

### Issue: Empty Technology String

**Cause:** `Rel(a, b, "Label", "")`

**Solution:** Omit fourth parameter entirely:
```plantuml
Rel(a, b, "Label")
```

### Issue: Technology Mismatch

**Cause:** Hardcoded technology instead of using discovery

**Solution:** Always use values from Discovery Summary:
- `stack.backend.framework` for backend framework name
- `stack.backend.orm` for ORM name
- `stack.backend.database` for database name

---

## Completeness Checklist

### Context Diagram
- [ ] `diagram_strategy.context.system_name` used in title
- [ ] One `Person()` per `diagram_strategy.context.users[]`
- [ ] One `System_Ext()` per `infrastructure.external_services[]`
- [ ] Metadata includes discovered system name

### Container Diagram
- [ ] One `Container()` per `diagram_strategy.containers[]`
- [ ] Technologies match `stack.backend` and `stack.frontend`
- [ ] Database matches `stack.backend.database`
- [ ] External services from `infrastructure.external_services[]`

### Component Diagram
- [ ] Architecture pattern from `architecture.backend.pattern` applied
- [ ] One group per `components.backend[].module`
- [ ] Technology labels use `stack.backend.framework`
- [ ] Entity labels use `stack.backend.orm`

### Code Diagram
- [ ] Stereotypes match `stack.backend.framework`
- [ ] Classes reflect actual module files
- [ ] Methods extracted from source code
- [ ] No generic types in properties/relationships

---

## Testing Procedure

### Step 1: Discovery Consistency

```
For each diagram element:
  - Find corresponding discovery field
  - Verify values match
  - Report mismatches
```

### Step 2: Syntax Check

- [ ] @startuml uses strict kebab-case lowercase
- [ ] All Rel() statements have correct syntax
- [ ] Metadata comments present at top
- [ ] No `Container_Boundary` in Component Diagrams
- [ ] No generic types in Code Diagram relationships

### Step 3: Rendering Test

- [ ] Open diagram in VS Code PlantUML viewer
- [ ] If errors, test in [PlantUML Online Server](http://www.plantuml.com/plantuml/uml/)
- [ ] No "Assumed diagram type" errors
- [ ] All elements render correctly

---

## PlantUML Online Server

For testing diagrams: http://www.plantuml.com/plantuml/uml/

This server has better C4-PlantUML support than some VS Code extensions.
